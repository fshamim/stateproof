sequenceDiagram
    participant UI as "UI/Caller"
    participant SM as "StateMachine.onEvent"
    participant Q as "eventQueue (ArrayDeque)"
    participant P as "Event Processor Loop"
    participant FX as "Transition SideEffect"

    UI->>SM: onEvent(OnLoginSubmitted(alice))
    SM->>Q: addLast(OnLoginSubmitted(alice))
    SM->>P: signal processing

    UI->>SM: onEvent(OnLoginSubmitted(bob))
    SM->>Q: addLast(OnLoginSubmitted(bob))
    SM->>P: signal processing

    P->>Q: removeFirst() returns OnLoginSubmitted(alice)
    P->>P: apply transition (state updated)
    P->>FX: run sideEffect(OnLoginSubmitted(alice))
    FX-->>P: emit OnAuthSucceeded(token)
    P->>Q: addFirst(OnAuthSucceeded(token))
    P->>P: signal processing

    Note over Q: Emitted event is inserted at the queue front

    P->>Q: removeFirst() returns OnAuthSucceeded(token)
    P->>P: process emitted event first

    P->>Q: removeFirst() returns OnLoginSubmitted(bob)
    P->>P: process next queued event
